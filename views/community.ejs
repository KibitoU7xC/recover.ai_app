<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Recover.AI - Community</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet" />
    <style>
        /* --- STYLES (Kept exactly as you like them) --- */
        :root { --brand-green: #2ecc71; --brand-blue: #4285f4; --bg-color: #f8f9fa; --card-bg: #ffffff; --text-dark: #333333; --text-light: #777777; --radius: 16px; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: "Segoe UI", sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-dark); height: 100vh; display: flex; flex-direction: column; }
        
        /* NAVBAR (Mobile Compatible) */
        .navbar { background-color: var(--card-bg); padding: 1rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .logo { font-weight: 700; color: var(--brand-green); text-decoration: none; display: flex; align-items: center; gap: 5px; }
        .nav-links { display: flex; gap: 15px; }
        .nav-link { text-decoration: none; color: var(--text-light); font-size: 0.9rem; }
        .nav-link.active { color: var(--text-dark); font-weight: 600; border-bottom: 2px solid var(--brand-green); }
        
        @media (max-width: 768px) { .nav-links { display: none; } } /* Hide nav on mobile if you have bottom nav */

        /* CHAT CONTAINER */
        .main-container { flex: 1; max-width: 800px; margin: 0 auto; width: 100%; padding: 1rem; display: flex; flex-direction: column; }
        .chat-card { background: white; border-radius: var(--radius); box-shadow: 0 4px 10px rgba(0,0,0,0.05); flex: 1; display: flex; flex-direction: column; overflow: hidden; height: 80vh; }
        
        /* MESSAGES AREA */
        .messages-area { flex: 1; padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #fcfcfc; }
        .message { max-width: 75%; display: flex; flex-direction: column; }
        .message.sent { align-self: flex-end; align-items: flex-end; }
        .message.received { align-self: flex-start; }
        
        .bubble { padding: 10px 14px; border-radius: 12px; font-size: 0.95rem; line-height: 1.4; word-wrap: break-word; }
        .message.sent .bubble { background-color: var(--brand-green); color: white; border-bottom-right-radius: 2px; }
        .message.received .bubble { background-color: #f0f2f5; color: var(--text-dark); border-bottom-left-radius: 2px; }
        
        .meta-info { font-size: 0.7rem; color: #999; margin-top: 4px; display: flex; gap: 5px; }
        
        /* INPUT AREA */
        .input-area { padding: 10px; background: white; border-top: 1px solid #eee; display: flex; gap: 10px; align-items: center; }
        .input-area input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 25px; outline: none; }
        .send-btn { background: var(--brand-blue); color: white; border: none; padding: 12px 20px; border-radius: 25px; font-weight: 600; cursor: pointer; }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="/dashboard" class="logo">Recover.AI</a>
        <div class="nav-links">
            <a href="/dashboard" class="nav-link">Dashboard</a>
            <a href="/community" class="nav-link active">Community</a>
        </div>
        <a href="/logout" style="text-decoration: none; font-size: 1.2rem;">üö™</a>
    </nav>

    <div class="main-container">
        <div class="chat-card">
            <div style="padding: 15px; border-bottom: 1px solid #eee;">
                <h3>Community Chat <span style="font-size: 0.8rem; color: var(--brand-green); background: #eafff3; padding: 2px 8px; border-radius: 10px;">‚óè Live</span></h3>
            </div>

            <div class="messages-area" id="messagesArea">
                <% if (messages && messages.length > 0) { %>
                    <% messages.forEach(msg => { %>
                        <div class="message <%= msg.sender === user.name ? 'sent' : 'received' %>">
                            <div class="bubble"><%= msg.text %></div>
                            <div class="meta-info">
                                <span><%= msg.sender %></span> ‚Ä¢ <span><%= msg.time %></span>
                            </div>
                        </div>
                    <% }); %>
                <% } else { %>
                    <div style="text-align: center; color: #ccc; margin-top: 20px;">No messages yet. Say hi! üëã</div>
                <% } %>
            </div>

            <div class="input-area">
                <input type="text" id="messageInput" placeholder="Type a message..." autocomplete="off" />
                <button class="send-btn" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io(); // Connect to server
        const messagesArea = document.getElementById("messagesArea");
        const messageInput = document.getElementById("messageInput");
        const myName = "<%= user.name %>"; // Valid EJS variable

        // Auto-scroll to bottom
        messagesArea.scrollTop = messagesArea.scrollHeight;

        // Send Message Function
        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text) return;

            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            // 1. Send to Server
            socket.emit("chat message", {
                sender: myName,
                text: text,
                time: timeString
            });

            // 2. Clear Input
            messageInput.value = "";
        }

        // Listen for Incoming Messages
        socket.on("chat message", (msg) => {
            const isMe = msg.sender === myName;
            
            const div = document.createElement("div");
            div.className = `message ${isMe ? 'sent' : 'received'}`;
            
            div.innerHTML = `
                <div class="bubble">${msg.text}</div>
                <div class="meta-info">
                    <span>${msg.sender}</span> ‚Ä¢ <span>${msg.time}</span>
                </div>
            `;
            
            messagesArea.appendChild(div);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        });

        // Send on 'Enter' key
        messageInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") sendMessage();
        });
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Check if running in Capacitor App
        if (window.Capacitor) {
            const { App } = Capacitor.Plugins;

            App.addListener('backButton', async () => {
                // Get the current page path (e.g., "/dashboard", "/food")
                const path = window.location.pathname;

                // LIST OF PAGES WHERE BACK BUTTON SHOULD CLOSE THE APP
                // usually Login and Dashboard are the "Home" pages
                if (path === '/dashboard' || path === '/login' || path === '/') {
                    App.exitApp();
                } else {
                    // For any other page (Food, Community, Chat), go back!
                    window.history.back();
                }
            });
        }
    });
</script>
</body>
</html>